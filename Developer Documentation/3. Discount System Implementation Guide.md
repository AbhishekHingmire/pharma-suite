# Discount System Implementation Guide

## Overview
Complete implementation of a comprehensive discount system supporting 8 different discount types with automatic calculation during purchase entry.

## Discount Types Implemented

### 1. **Free Quantity (freeQty)**
- **Description**: Buy X, Get Y Free scheme
- **Example**: Buy 100 units, Get 10 free
- **Calculation**: Free quantity = Floor(Purchased Qty / Buy Qty) × Free Qty
- **Usage**: Most common for bulk purchases
- **Fields**: `buyQty`, `freeQty`

### 2. **Flat Discount (discount)**
- **Description**: Fixed percentage discount on purchase
- **Example**: 5% discount on all items (with optional minimum quantity)
- **Calculation**: Discount Amount = (Item Amount × Discount %) / 100
- **Usage**: General promotional discounts
- **Fields**: `discountPercent`, `minPurchaseQty` (optional)

### 3. **Slab Discount (slab)**
- **Description**: Tiered discounts based on quantity ranges
- **Example**: 
  - 0-100 units: 2% discount
  - 101-500 units: 5% discount
  - 501+ units: 8% discount
- **Calculation**: Finds applicable slab based on quantity, applies corresponding discount %
- **Usage**: Incentivize larger purchases
- **Fields**: `slabs` (array of `{minQty, maxQty, discount}`)

### 4. **Cash Discount (cash)**
- **Description**: Discount for early payment
- **Example**: 2% discount if paid within 7 days
- **Calculation**: Similar to flat discount
- **Usage**: Encourage quick payments
- **Fields**: `cashDiscountPercent`, `paymentDays`
- **Note**: Currently applied at item level, can be enhanced for invoice-level

### 5. **Volume Discount (volume)**
- **Description**: Tiered discounts based on total invoice amount (not quantity)
- **Example**:
  - ₹0-10,000: 1% discount
  - ₹10,001-50,000: 3% discount
  - ₹50,001+: 5% discount
- **Calculation**: Checks invoice subtotal against amount slabs
- **Usage**: Reward high-value purchases
- **Fields**: `volumeSlabs` (array of `{minAmount, maxAmount, discount}`)
- **Note**: Invoice-level discount type

### 6. **Trade Discount (trade)**
- **Description**: Fixed percentage discount for retailers/wholesalers
- **Example**: 10% trade discount for all B2B customers
- **Calculation**: Fixed percentage applied to item amount
- **Usage**: Standard discount for trade partners
- **Fields**: `tradeDiscountPercent`

### 7. **Seasonal/Promotional (seasonal)**
- **Description**: Time-based promotional offers
- **Example**: 15% Diwali Sale (valid Oct 20 - Nov 5)
- **Calculation**: Fixed percentage during validity period
- **Usage**: Festival sales, clearance sales
- **Fields**: `seasonalDiscountPercent`, `promoName` (optional)

### 8. **Combo Discount (combo)**
- **Description**: Discount when buying multiple specific products together
- **Example**: Buy Paracetamol + Ibuprofen together, get 12% off
- **Calculation**: Applied when all combo products are in the purchase
- **Usage**: Cross-selling, moving slow items
- **Fields**: `comboProducts` (array of product IDs), `comboDiscountPercent`
- **Note**: Requires all listed products in cart

## Technical Implementation

### Data Structure

#### Scheme Interface (`types/index.ts`)
```typescript
interface Scheme {
  id: number;
  companyId: number;
  type: 'freeQty' | 'discount' | 'slab' | 'cash' | 'volume' | 'trade' | 'seasonal' | 'combo';
  
  // Type-specific fields
  buyQty?: number;
  freeQty?: number;
  discountPercent?: number;
  minPurchaseQty?: number;
  slabs?: { minQty: number; maxQty: number; discount: number }[];
  cashDiscountPercent?: number;
  paymentDays?: number;
  volumeSlabs?: { minAmount: number; maxAmount: number; discount: number }[];
  tradeDiscountPercent?: number;
  seasonalDiscountPercent?: number;
  promoName?: string;
  comboProducts?: number[];
  comboDiscountPercent?: number;
  
  // Common fields
  validFrom: string;
  validTo: string;
  products: number[] | 'all';
  status: 'active' | 'inactive';
}
```

#### PurchaseItem Interface (Extended)
```typescript
interface PurchaseItem {
  productId: number;
  companyId: number;
  brandName: string;
  qty: number;
  freeQty: number;
  batch: string;
  expiry: string;
  rate: number;
  amount: number;
  
  // Discount fields
  discountPercent?: number;    // Percentage of discount applied
  discountAmount?: number;     // Rupee amount of discount
  finalAmount?: number;         // Amount after discount
}
```

### Scheme Management (`Schemes.tsx`)

#### Creating Schemes
1. Navigate to Masters > Schemes
2. Click "Add Scheme"
3. Select Company
4. Choose Scheme Type (shows 8 options with descriptions)
5. Fill type-specific fields:
   - **Free Qty**: Buy Qty, Free Qty
   - **Flat Discount**: Discount %, Min Qty (optional)
   - **Slab**: Add multiple slabs with Min/Max Qty and Discount %
   - **Cash**: Cash Discount %, Payment Days
   - **Volume**: Add amount-based slabs
   - **Trade**: Trade Discount %
   - **Seasonal**: Discount %, Promo Name
   - **Combo**: Select products, Discount %
6. Set validity dates (From-To)
7. Set status (Active/Inactive)

#### Scheme Filtering
- **Active Tab**: Shows currently active schemes (default view)
- **Upcoming Tab**: Shows schemes not yet started
- **Expired Tab**: Shows past schemes (read-only, cannot edit/delete)

#### Scheme Display
Each scheme card shows:
- Company name
- Scheme description (auto-generated based on type)
- Status badge (color-coded)
- Validity dates
- Days remaining (for active schemes)
- Edit/Delete buttons (hidden for expired)

### Purchase Module Integration (`NewPurchase.tsx`)

#### Automatic Discount Calculation

**Step 1: Scheme Selection**
- Dropdown shows schemes filtered by:
  - Selected company
  - Product eligibility
  - Active status (not expired/upcoming)
  - Applicability (meets minimum requirements)

**Step 2: Real-time Calculation**
When user enters/changes quantity or rate:
```typescript
updateItem() {
  // 1. Calculate base amount
  item.amount = qty × rate
  
  // 2. If scheme applied, recalculate discount
  if (scheme) {
    switch(scheme.type) {
      case 'freeQty':
        // Calculate free quantity
        item.freeQty = Floor(qty / buyQty) × freeQty
        
      case 'discount':
        // Apply flat discount if min qty met
        if (qty >= minPurchaseQty) {
          item.discountPercent = scheme.discountPercent
          item.discountAmount = amount × discountPercent / 100
          item.finalAmount = amount - discountAmount
        }
        
      case 'slab':
        // Find applicable slab
        slab = findSlab(qty)
        item.discountPercent = slab.discount
        item.discountAmount = amount × discountPercent / 100
        item.finalAmount = amount - discountAmount
        
      // Similar for other types...
    }
  }
}
```

**Step 3: Visual Display**
```
Amount: ₹1,000.00
Discount: 5.00% -₹50.00
Final Amount: ₹950.00
```

#### Scheme Verification (for Free Qty schemes)
- Checkbox verification for freeQty schemes
- Ensures free products are actually received
- Prevents saving without verification

#### Total Calculation
```typescript
calculateTotals() {
  // Use finalAmount if discount applied, else use amount
  subtotal = sum of (finalAmount || amount) for all items
  gst = subtotal × 0.12
  total = subtotal + gst
}
```

## Usage Examples

### Example 1: Free Quantity Scheme
**Scheme**: Dr Reddy's - Buy 100, Get 10 Free
```
User enters: 250 units @ ₹10/unit
Calculation:
- Multiplier = Floor(250 / 100) = 2
- Free Qty = 2 × 10 = 20 units
- Amount = 250 × ₹10 = ₹2,500
- Final Amount = ₹2,500 (no discount on amount)
- Effective rate = ₹2,500 / 270 units = ₹9.26/unit
```

### Example 2: Flat Discount
**Scheme**: Sun Pharma - 5% Discount (Min: 50 units)
```
User enters: 100 units @ ₹15/unit
Calculation:
- Qty check: 100 >= 50 ✓
- Amount = 100 × ₹15 = ₹1,500
- Discount % = 5%
- Discount Amount = ₹1,500 × 5% = ₹75
- Final Amount = ₹1,500 - ₹75 = ₹1,425
```

### Example 3: Slab Discount
**Scheme**: Cipla - Slab Discount
- 0-100 units: 2%
- 101-500 units: 5%
- 501+ units: 8%

```
User enters: 300 units @ ₹20/unit
Calculation:
- Applicable slab: 101-500 units
- Discount % = 5%
- Amount = 300 × ₹20 = ₹6,000
- Discount Amount = ₹6,000 × 5% = ₹300
- Final Amount = ₹6,000 - ₹300 = ₹5,700
```

### Example 4: Combo Discount
**Scheme**: Multi-product Combo - 12% off
- Products: Paracetamol (ID: 1), Ibuprofen (ID: 2)

```
When user adds both products:
- Each item shows 12% discount
- Applied individually to each item's amount
```

## API Development Notes (For Backend Implementation)

### Endpoints Needed

```
GET /api/schemes
- Returns active schemes filtered by company/product
- Include validation status (active/upcoming/expired)

POST /api/schemes
- Create new scheme with type-specific validation
- Validate slab ranges don't overlap
- Ensure valid date ranges

PUT /api/schemes/:id
- Update existing scheme
- Prevent editing expired schemes (optional)

DELETE /api/schemes/:id
- Soft delete or restrict if used in purchases
- Keep for historical reporting

POST /api/purchases/calculate-discount
- Helper endpoint to calculate discount before saving
- Input: items[], schemes[]
- Output: items with discount applied
```

### Database Schema

```sql
CREATE TABLE schemes (
  id INT PRIMARY KEY AUTO_INCREMENT,
  company_id INT NOT NULL,
  type ENUM('freeQty', 'discount', 'slab', 'cash', 'volume', 'trade', 'seasonal', 'combo'),
  
  -- Type-specific JSON fields
  config JSON, -- Stores type-specific data
  
  -- Common fields
  valid_from DATE NOT NULL,
  valid_to DATE NOT NULL,
  products JSON, -- Array of product IDs or 'all'
  status ENUM('active', 'inactive') DEFAULT 'active',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  
  FOREIGN KEY (company_id) REFERENCES companies(id)
);

CREATE TABLE scheme_slabs (
  id INT PRIMARY KEY AUTO_INCREMENT,
  scheme_id INT NOT NULL,
  slab_type ENUM('quantity', 'amount'),
  min_value DECIMAL(10,2),
  max_value DECIMAL(10,2),
  discount_percent DECIMAL(5,2),
  FOREIGN KEY (scheme_id) REFERENCES schemes(id) ON DELETE CASCADE
);

CREATE TABLE purchase_items (
  id INT PRIMARY KEY AUTO_INCREMENT,
  purchase_id INT NOT NULL,
  product_id INT NOT NULL,
  company_id INT NOT NULL,
  brand_name VARCHAR(255),
  qty INT NOT NULL,
  free_qty INT DEFAULT 0,
  batch VARCHAR(50),
  expiry DATE,
  rate DECIMAL(10,2) NOT NULL,
  amount DECIMAL(10,2) NOT NULL,
  
  -- Discount fields
  scheme_id INT, -- Reference to applied scheme
  discount_percent DECIMAL(5,2) DEFAULT 0,
  discount_amount DECIMAL(10,2) DEFAULT 0,
  final_amount DECIMAL(10,2),
  
  FOREIGN KEY (purchase_id) REFERENCES purchases(id) ON DELETE CASCADE,
  FOREIGN KEY (scheme_id) REFERENCES schemes(id)
);
```

## Validation Rules

### Scheme Creation
1. **Free Qty**: buyQty > 0, freeQty > 0
2. **Flat Discount**: discountPercent > 0 and <= 100
3. **Slab**: 
   - At least 1 slab required
   - No overlapping ranges
   - All discounts > 0 and <= 100
4. **Cash**: cashDiscountPercent > 0, paymentDays > 0
5. **Volume**: Similar to slab validation
6. **Trade**: tradeDiscountPercent > 0 and <= 100
7. **Seasonal**: seasonalDiscountPercent > 0 and <= 100
8. **Combo**: 
   - At least 2 products required
   - comboDiscountPercent > 0 and <= 100

### Purchase Entry
1. Scheme must be active (not expired/upcoming)
2. Must meet minimum quantity requirements
3. Product must be eligible for scheme
4. Free Qty schemes require verification checkbox
5. Discount calculation must be accurate

## Future Enhancements

### Phase 2
1. **Multi-level Discounts**: Apply multiple schemes on same item
2. **Customer-specific Schemes**: Tie schemes to customer types (A/B/C)
3. **Auto-apply Schemes**: Automatically apply best scheme
4. **Scheme Analytics**: Track scheme usage, savings, ROI
5. **Approval Workflow**: Require approval for high-value discounts

### Phase 3
1. **Volume Discount at Invoice Level**: Apply based on total invoice amount
2. **Combo Validation**: Ensure all combo products are present
3. **Scheme Suggestions**: AI-based scheme recommendations
4. **Coupon Codes**: Allow customers to enter promo codes
5. **Loyalty Points**: Integration with loyalty program

## Testing Checklist

- [ ] Create each discount type successfully
- [ ] Edit existing schemes (except expired)
- [ ] Delete schemes (except expired)
- [ ] Filter by Active/Upcoming/Expired
- [ ] Search schemes by company name
- [ ] Apply Free Qty scheme in purchase
- [ ] Apply Flat Discount in purchase
- [ ] Apply Slab Discount with different quantities
- [ ] Verify discount recalculation on qty/rate change
- [ ] Check scheme dropdown filtering (expired/upcoming/ineligible hidden)
- [ ] Verify total calculation includes discounts
- [ ] Test minimum quantity validation
- [ ] Test slab range validation
- [ ] Verify read-only access for expired schemes
- [ ] Test mobile responsiveness of scheme cards
- [ ] Verify discount display in purchase items

## Support & Maintenance

### Common Issues

**Issue**: Discount not applying
- **Check**: Scheme is active (not expired)
- **Check**: Quantity meets minimum requirement
- **Check**: Product is eligible for scheme
- **Check**: Scheme dates are valid

**Issue**: Wrong discount amount
- **Check**: Calculation logic for specific discount type
- **Check**: Slab ranges are correct
- **Check**: Amount is calculated before discount

**Issue**: Cannot edit scheme
- **Check**: Scheme is not expired (expired schemes are read-only)

### Performance Optimization
1. Index scheme validity dates for faster filtering
2. Cache active schemes per company
3. Lazy load scheme dropdown (only when company selected)
4. Debounce discount calculation on qty/rate change

---

**Document Version**: 1.0  
**Last Updated**: November 21, 2025  
**Author**: AI Development Team  
**Status**: ✅ Implemented & Tested
